<html>
<head>
  <title>Flow Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="config.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous"></script>
  <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/js/bootstrap-dialog.min.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
  <style>
    .well {
      margin-bottom: 5px;
    }
    .col-sm-5, .col-sm-2 {
      padding-right: 5px;
      padding-left: 5px;
    }

    .placeholder {
      border: 1px solid green;
      background-color: white;
      -webkit-box-shadow: 0px 0px 10px #888;
      -moz-box-shadow: 0px 0px 10px #888;
      box-shadow: 0px 0px 10px #888;
    }

    .draghandle {
      cursor: ns-resize;
    }

    .colorbox {
      display: inline-block;
      height: 13px;
      width: 13px;
      vertical-align: text-top;
    }
  </style>
</head>
<body>
  <div class=container-fluid>
    <h1>Homey flow viewer</h1>
    <div class="form-group has-feedback">
        <input id="search" type="text" class="form-control" placeholder="Search" onKeyDown="search()" onKeyUp="search()" onChange="search()"/>
        <i class="glyphicon glyphicon-search form-control-feedback"></i>
    </div>
    <div id="flows">
      <span id="wait">Wait for it...</span>
    </div>
    <div class="hide">
      <div class="template_flow">
        <div class="panel panel-success" data="flow" flow_id="">
          <div class="panel-heading">
            <div class="row">
              <div class="col-sm-4" data="flow_path"></div>
              <div class="col-sm-4 text-center">
                <span class="text-muted" data="test_btn" data-toggle="tooltip" title="Test flow"><i class="fa fa-play"></i></span>
                &nbsp;&nbsp;
                <strong data="title"></strong>
              </div>
              <div class="col-sm-4 text-right">
                <span class="label label-default" data="label_disabled"></span>
                <span class="label label-danger" data="label_broken"></span>
                <button class="btn btn-default" data="toggle_btn" data-toggle="tooltip" title="Enable or disable"><i class="fa fa-square-o"></i></button>
                <button class="btn btn-default" data="edit_btn"   data-toggle="tooltip" title="Rename & Move"><i class="fa fa-pencil"></i></button>
                <button class="btn btn-default" data="copy_btn"   data-toggle="tooltip" title="Copy"><i class="fa fa-clone"></i></button>
                <button class="btn btn-default" data="delete_btn" data-toggle="tooltip" title="Delete"><i class="fa fa-remove"></i></button>
              </div>
            </div>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-sm-2 small">
                <div class="text-muted">Trigger</div>
                <span data="cards_trigger"/>
              </div>
              <div class="col-sm-5 small">
                <div class="text-muted">Conditions</div>
                <span data="cards_condition"/>
              </div>
              <div class="col-sm-5 small">
                <div class="text-muted">Actions</div>
                <span data="cards_action"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="template_card">
        <div data="card" class="card">
          <div class="well well-sm">
            <span class="label label-danger" data="label_danger"></span>
            <span class="label label-success pull-right" data="card_type_device"></span>
            <span class="label label-info pull-right" data="card_type_app"></span>
            <span class="label label-primary pull-right" data="card_type_manager"></span>
            <span class="text-muted draghandle" data="move_card_btn"><i class="fa fa-arrows"></i></span>&nbsp;
            <span class="text-muted" data="edit_card_btn" data-toggle="tooltip" title="Edit"><i class="fa fa-pencil"></i></span>&nbsp;
            <span class="text-muted" data="test_card_btn" data-toggle="tooltip" title="Test"><i class="fa fa-play"></i></span>
            &nbsp;&nbsp;
            <span class="text-nowrap"><strong data="card_title"></strong></span><br>
            <span class="text-muted" data="card_args"></span>
            <span class="text-muted" data="card_delay"></span>
            <span class="text-muted" data="card_droptoken"></span>
          </div>
        </div>
      </div>

      <div class="dialog_copy form-group">
        <label for="copyName">New name</label>
        <input id="copyName" class="form-control" type="text"  value="">
        <label for="copyFolder">Copy to folder</label>
        <select id="copyFolder" class="form-control">
          <option value="false">None</option>
        </select>
      </div>

      <div class="dialog_edit form-group">
        <label for="editName">Name</label>
        <input id="editName" class="form-control" type="text"  value="">
        <label for="editFolder">Folder</label>
        <select id="editFolder" class="form-control">
          <option value="false">None</option>
        </select>
      </div>

      <div class="dialog_test form-group">
        <span class="text-muted" data="test_status"></span>
      </div>
      <!-- <div class="dialog_edit_card form-group">
        <label for="delay">Delay</label>
        <input id="delay" class="form-control" type="text"  value="">
        <div class="arguments"></div>
      </div>

      <div class="dialog_edit_card_argument text form-group">
        <label for="field"></label>
        <input id="field" class="form-control" type="text"  value="">
      </div>

      <div class="dialog_edit_card_argument text form-group">
        <label for="field"></label>
        <input id="field" class="form-control" type="number"  value="">
      </div> -->
    </div>
  </div>
  <script>
  var devices = []
  var cards
  var folders = []
  var flows = []

  if (setup.ip === '0.0.0.0') alert('Configure your Homey IP in this script...')
  if (setup.bearer_token === 'your token') alert('Configure your Bearer token in this script...')

  $.ajaxSetup({
    contentType : 'application/json',
    headers: {Authorization: 'Bearer ' + setup.bearer_token}
  })

  jQuery.expr[':'].icontains = jQuery.expr.createPseudo(function (arg) {
    return function (elem) {
      return jQuery(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0
    }
  })

  String.prototype.capitalizeFirstLetter = function() {
      return this.charAt(0).toUpperCase() + this.slice(1)
  }

  function addFlow (flow) {
    var newFlow = $('.template_flow').clone()
    $(newFlow).find('[data=flow]').attr('flow_id', flow.id)
    $(newFlow).find('[data=title]').html(`<a href="${setup.protocol}://${setup.ip}/manager/flow/#${flow.id}" target=_new>${flow.title}</a>`)
    $(newFlow).find('[data=cards_trigger]').append(formatCard(flow.id, flow.trigger, 'trigger', 0).html())
    $(newFlow).find('[data=cards_condition]').append(formatCards(flow, 'conditions').html())
    $(newFlow).find('[data=cards_action]').append(formatCards(flow, 'actions').html())
    $(newFlow).find('[data=toggle_btn]').attr('onClick', `toggleFlow('${flow.id}')`)
    $(newFlow).find('[data=edit_btn]').attr('onClick', `editFlow('${flow.id}')`)
    $(newFlow).find('[data=copy_btn]').attr('onClick', `copyFlow('${flow.id}')`)
    $(newFlow).find('[data=delete_btn]').attr('onClick', `deleteFlow('${flow.id}')`)
    $(newFlow).find('[data=test_btn]').attr('onClick', `testFlow('${flow.id}')`)
    if (flow.folder) $(newFlow).find('[data=flow_path]').html('<i class="fa fa-folder-open" aria-hidden="true"></i> ' + formatFolder(flow.folder))
    if (flow.broken) {
      $(newFlow).find('[data=flow]').removeClass("panel-success").addClass("panel-danger")
      $(newFlow).find('[data=label_broken]').html("BROKEN")
    }
    $('#flows').append(newFlow.html())
    showFlowToggleButton(flow.id)
  }

  function noCard () {
    var noCard = $('<div />')
    noCard.html('<br><span class="label label-danger">NO CARD</span>')
    return noCard
  }

  function formatCards (flow, type) {
    if (type === 'actions' && flow[type].length === 0) return noCard()
    var newCards = $("<div />")
    flow[type].forEach(function (card, index) {
      newCards.append(formatCard(flow.id, card, type, index).html())
    })
    return newCards
  }

  function formatCard (flowId, card, type, index) {
    if (isEmptyObject(card)) return noCard()
    var newCard = $('.template_card').clone()
    var definitions = getCard(card.uri, (type === 'trigger') ? type : type.slice(0, -1), card.id)
    var app = getApp(card.uri)

    $(newCard).find('[data=card]').attr('card_index', index)
    if (type === 'conditions') {
      $(newCard).find('[data=card_title]').html(conditionTitleParse(definitions.title.en, !card.inverted))
    } else {
      $(newCard).find('[data=card_title]').html(definitions.title.en)
    }

    $(newCard).find('[data=card_type_' + app.uriObj.type + ']').html(app.uriObj.name)
    if (!isEmptyObject(card.args)) $(newCard).find('[data=card_args]').html(formatArgs(card, definitions))
    if (card.delay && card.delay.number > 0) $(newCard).find('[data=card_delay]').html('<i>delay</i>: ' + (card.delay.number * card.delay.multiplier) + ' seconds')
    if (card.droptoken) $(newCard).find('[data=card_droptoken]').html('<i>token</i>: <code>' + (card.droptoken) + '</code>')
    if (definitions.tokens) {
      var tokens = '<i>tokens</i>: '
      definitions.tokens.forEach(token => {
        tokens += '<code>' + (token.name) + '</code> '
      })
      $(newCard).find('[data=card_droptoken]').html(tokens)
    }
    if (type === 'trigger') $(newCard).find('[data=move_card_btn], [data=test_card_btn]').remove()
    $(newCard).find('[data=test_card_btn]').attr('onClick', `testCard('${flowId}','${type}',${index})`)
    return newCard
  }

  function formatFolder (id) {
    var result = getFolder(id).title
    if (getFolder(id).folder) result = formatFolder(getFolder(id).folder) + " > " + result
    return result
  }

  function formatArgs (card, definitions) {
    var output = ''
    Object.keys(card.args).forEach(function (argument) {
      if (Object.prototype.toString.call(definitions.args) === '[object Object]') definitions.args = [definitions.args]
      output += '<i>' + argument + '</i>: ' + formatArgValue(definitions.args.filter(item => item.name === argument)[0], card.args[argument]) + '<br>'
    })
    output = output.replace('[[', '<code>').replace(']]', '</code>')
    return output
  }

  function formatArgValue (argDef, value) {
    switch (argDef.type) {
      case 'autocomplete':
        return value.name
      case 'dropdown':
        return argDef.values.filter(item => item.id === value)[0].label.en
      case 'color':
        return `<span class="colorbox" style="background-color: ${value}"> </span> (${value})`
      case 'range':
        return value * (argDef.labelMultiplier || 1) + (argDef.label || '')
      case 'text':
      case 'number':
      case 'time':
        return value
      default:
        console.log(argDef, value)
        return value
    }
  }

  function isEmptyObject (obj) {
    return Object.getOwnPropertyNames(obj).length === 0
  }

  function conditionTitleParse (e, t) {
    var a = e.match(/\!\{\{(.*?)\}\}/g)
    if (a === null) return e
    a.forEach(function(a) {
      var n = a
      if('!' == a.charAt(0)) a = a.substring(1)
      e = e.replace(n, a.replace('{{', '').replace('}}', '').split('|')[t ? 0 : 1] || '')
    })
    return e
  }

  function getApp (uri) {
    return cards.filter(app => app.uri === uri)[0]
  }

  function getCard (uri, type, id) {
    return getApp(uri).cards[type].filter(card => card.id === id)[0]
  }

  function getDevice (id) {
    return devices.filter(device => device.id === id)[0]
  }

  function getFlow (id) {
    return flows.filter(flow => flow.id === id)[0]
  }

  function getFolder (id) {
    return folders.filter(folder => folder.id === id)[0]
  }

  function loadCards (callback) {
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/card/`, function(data) {
      cards = data.result
      callback()
    })
  }

  function loadDevices (callback) {
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/devices/device/`, function(data) {
      $.each(data.result, function (index, resultDevice) {
        devices.push({id: resultDevice.id, name: resultDevice.name})
      })
      callback()
    })
  }

  function loadFlows (callback) {
    // get all flow folders
    flows = []
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/`, function(data) {
      $.each(data.result, function (index, flow) {
        flows.push(flow)
      })
      callback()
    })
  }

  function loadFolders (callback) {
    folders = []
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/folder/`, function(data) {
      $.each(data.result, function (index, folder) {
        folders.push(folder)
      })
      sortFolders()
      callback()
    })
  }

  function folderOrder (id) {
    var order = formatOrderNumber(getFolder(id).order) + '|'
    if (getFolder(id).folder) order = folderOrder(getFolder(id).folder) + order
    return order
  }

  function formatOrderNumber (order) {
    return ('00000' + order).slice(-5)
  }

  function sortFolders () {
    folders.forEach(folder => {
      folder.sorting = folderOrder(folder.id)
    })
    folders.sort((a, b) => (a.sorting > b.sorting ? 1 : -1))
  }

  function showFlows (callback) {
    flows.forEach(flow => {
      flow.order = formatOrderNumber(flow.order)
      if (flow.folder) flow.order = folderOrder(flow.folder) + flow.order
    })
    flows.sort((a, b) => (a.order > b.order ? 1 : -1))
    flows.forEach(flow => {
      addFlow(flow)
    })
    callback()
  }

  $.getScript(`${setup.protocol}://${setup.ip}/socket.io/socket.io.js`, () => {
    loadDevices(() => {
      loadFolders(() => {
        loadCards(() => {
          loadFlows(() => {
            showFlows(() => {
              $('#wait').remove()
              setTimeout(ready, 1000)
            })
          })
        })
      })
    })
  })

  function ready() {
    $('[data-toggle="tooltip"]').tooltip()
    $('[data=cards_action], [data=cards_condition]').sortable({
      handle: '[data=move_card_btn]',
      tolerance: 'pointer',
      revert: 'invalid',
      placeholder: 'placeholder well well-sm',
      forceHelperSize: true,
      start: function(event, ui) {
        ui.placeholder.height(ui.item.find('.well').height())
      },
      stop: function (event, ui) {
        var flowId = ui.item.parents('[data=flow]').attr('flow_id')
        var actionsOrder = []
        var conditionsOrder = []
        $(`[flow_id=${flowId}] [data=cards_condition] .card`).each(function (card) { conditionsOrder.push($(this).attr('card_index') * 1); $(this).attr('card_index', card) } )
        $(`[flow_id=${flowId}] [data=cards_action] .card`).each(function (card) { actionsOrder.push($(this).attr('card_index') * 1); $(this).attr('card_index', card) } )
        saveFlowCardOrder(flowId, conditionsOrder, actionsOrder)
      }
    })
  }

  function copyFlow (flowId) {
    copyFlowDialog(flowId, function(newName, newFolder) {
      if (newName) {
        if (newFolder === 'false') newFolder = false
        $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
          if (data.status !== 200) return alert('Copy failure... getting existing flow')
          var existingFlow = data.result
          $.post(`${setup.protocol}://${setup.ip}/api/manager/flow/flow`, function(data) {
            if (data.status !== 200) return alert('Copy failure... requesting new id')
            var newFlow = existingFlow
            newFlow.id = data.result.id
            newFlow.title = newName
            newFlow.folder = newFolder
            newFlow.order = data.result.order
            $.ajax({
              url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${newFlow.id}`,
              type: 'PUT',
              data: JSON.stringify(newFlow),
              success: function(data) {
                location.reload()
              }
            })
          })
        })
      }
    })
  }

  function deleteFlow (flowId) {
    deleteFlowDialog(flowId, function(doDelete) {
      if (!doDelete) return
      $.ajax({
        url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
        type: 'DELETE',
        success: function(data) {
          $(`[flow_id=${flowId}]`).slideUp(1000)
        }
      })
    })
  }

  function showFlowToggleButton (flowId) {
    if (getFlow(flowId).enabled) {
      $(`[flow_id=${flowId}] [data=label_disabled]`).html("")
      $(`[flow_id=${flowId}] [data=toggle_btn] i`).removeClass('fa-square-o').addClass('fa-check-square-o')
      if (!getFlow(flowId).broken) {
        $(`[flow_id=${flowId}]`).removeClass("panel-default").addClass("panel-success")
      }
    } else {
      $(`[flow_id=${flowId}] [data=label_disabled]`).html("DISABLED")
      $(`[flow_id=${flowId}] [data=toggle_btn] i`).removeClass('fa-check-square-o').addClass('fa-square-o')
      if (!getFlow(flowId).broken) {
        $(`[flow_id=${flowId}]`).removeClass("panel-success").addClass("panel-default")
      }
    }
  }

  function editFlow (flowId) {
    editFlowDialog(flowId, function(newName, newFolder) {
      if (newName) {
        if (newFolder === 'false') newFolder = false
        $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
          if (data.status !== 200) return alert('Edit failure... getting existing flow')
          var existingFlow = data.result
          existingFlow.title = newName
          existingFlow.folder = newFolder
          $.ajax({
            url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
            type: 'PUT',
            data: JSON.stringify(existingFlow),
            success: function(data) {
              location.reload()
            }
          })
        })
      }
    })
  }

  function toggleFlow (flowId) {
    flows.filter(flow => flow.id === flowId)[0].enabled = !getFlow(flowId).enabled
    $.ajax({
      url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
      type: 'PUT',
      data: JSON.stringify({enabled: getFlow(flowId).enabled}),
      success: function(data) {
        showFlowToggleButton(flowId)
      }
    })
  }

  function copyFlowDialog (flowId, callback) {
    var message = $('.dialog_copy').clone()
    $(message).find('[id=copyName]').attr('value', `${getFlow(flowId).title} (copy)`)
    folders.forEach(folder => {
      $(message).find('[id=copyFolder]').append($("<option></option>").attr("value", folder.id).text(formatFolder(folder.id)))
    })
    $(message).find('[id=copyFolder]').val(getFlow(flowId).folder.toString())
    BootstrapDialog.show({
      title: 'Copy flow',
      message: message,
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Copy',
          action: function (dialogRef) {
            var newName = dialogRef.getModalBody().find('[id=copyName]').val()
            var newFolder = dialogRef.getModalBody().find('[id=copyFolder]').val()
            dialogRef.close()
            callback(newName, newFolder)
          }
        }
      ]
    })
  }

  function deleteFlowDialog (flowId, callback) {
    BootstrapDialog.show({
      title: 'Delete flow',
      message: 'Are you sure you want to delete flow ' + getFlow(flowId).title + '?',
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Delete',
          action: function (dialogRef) {
            dialogRef.close()
            callback(true)
          }
        }
      ]
    })
  }

  function editFlowDialog (flowId, callback) {
    var message = $('.dialog_edit').clone()
    $(message).find('[id=editName]').attr('value', `${getFlow(flowId).title}`)
    folders.forEach(folder => {
      $(message).find('[id=editFolder]').append($("<option></option>").attr("value", folder.id).text(formatFolder(folder.id)))
    })
    $(message).find('[id=editFolder]').val(getFlow(flowId).folder.toString())
    BootstrapDialog.show({
      title: 'Edit and move flow',
      message: message,
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Save',
          action: function (dialogRef) {
            var editName = dialogRef.getModalBody().find('[id=editName]').val()
            var editFolder = dialogRef.getModalBody().find('[id=editFolder]').val()
            dialogRef.close()
            callback(editName, editFolder)
          }
        }
      ]
    })
  }

  function testDialog () {
    var message = $('.dialog_test').clone()
    $(message).find('[id=test_status]').html('xxxx')
    return BootstrapDialog.show({
      title: 'Testing',
      message: message,
      closable: false
    })
  }

  function orderArrayByIndexMap (array, indexMap) {
    var result = []
    indexMap.forEach((order, index) => result[index] = array[order])
    return result
  }

  function indexMapHasChanged (indexMap) {
    var result = false
    indexMap.forEach((order, index) => {if (order !== index) { result = true }})
    return result
  }

  function saveFlowCardOrder (flowId, conditionsOrder, actionsOrder) {
    if (!(indexMapHasChanged(conditionsOrder) || indexMapHasChanged(actionsOrder))) return
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
      if (data.status !== 200) return alert('Failure... getting existing flow')
      var existingFlow = data.result
      existingFlow.conditions = orderArrayByIndexMap(existingFlow.conditions, conditionsOrder)
      existingFlow.actions = orderArrayByIndexMap(existingFlow.actions, actionsOrder)
      $.ajax({
        url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
        type: 'PUT',
        data: JSON.stringify(existingFlow),
        success: function(data) {
          console.log('order saved')
          // location.reload()
        }
      })
    })
  }

  function search () {
    value = $('[id=search]').val()
    $('[data=flow]').hide()
    $(`:icontains(${value})`).parents('[data=flow]').show()
  }
  var dialog
  function test (flowId, testFlow, testCardIndex) {
    console.log(flowId, testFlow, testCardIndex)
    dialog = testDialog()
    var socket = io.connect(`${setup.protocol}://${setup.ip}/realtime/manager/flow/`, {query: `token=${setup.bearer_token}`, transports: ['websocket', 'polling']})
    var session
    var cards = {total: testFlow.flow.conditions.length + testFlow.flow.actions.length, running: 0, passed: 0, failed: 0}
    console.log('testing flow', cards, flowId)
    socket.on('test', function (data) {
      if (data.test_id !== session) return
      cards[data.state] += 1
      dialog.$modalDialog.find('span').html(JSON.stringify(cards))
      if (data.state === 'passed') {
        $('[flow_id=' + flowId + '] [data=cards_' + data.card_type + '] .well').eq(testCardIndex || data.card_index).css('background-color', 'lightgreen').animate({'background-color': '#f5f5f5'}, 1500)
      }
      if (data.state === 'failed') {
        $('[flow_id=' + flowId + '] [data=cards_' + data.card_type + '] .well').eq(testCardIndex || data.card_index).css('background-color', 'red').animate({'background-color': '#f5f5f5'}, 3000)
        console.log('test failed', cards)
        socket.close()
        dialog.addButton({ label: 'Close', action: function (dialogRef) { dialogRef.close() } }).updateButtons()
      }
      if (cards.total === cards.passed) {
        console.log('test complete', cards)
        socket.close()
        dialog.addButton({ label: 'Close', action: function (dialogRef) { dialogRef.close() } }).updateButtons()
      }
    })
    socket.on('connect', function () {
      $.ajax({
        url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/test/`,
        type: 'POST',
        data: JSON.stringify(testFlow),
        success: function(data) {
          session = data.result
        }
      })
    })
  }

  function testCard (flowId, type, index) {
    var testflow = {
      "flow":{
        "trigger":{},
        "conditions":[],
        "actions":[]
      },
      "tokens":{}
    }

    if (!isEmptyObject(getFlow(flowId).trigger)) {
      (getCard(getFlow(flowId).trigger.uri, 'trigger', getFlow(flowId).trigger.id).tokens || []).forEach(token => {
        testflow.tokens[token.name] = token.example.en
      })
    }

    testflow.flow[type].push(getFlow(flowId)[type][index])
    test(flowId, testflow, index)
  }

  function testFlow (flowId) {
    var testflow = {
      "flow":{
        "trigger":{},
        "conditions":[],
        "actions":[]
      },
      "tokens":{}
    }

    if (!isEmptyObject(getFlow(flowId).trigger)) {
      getCard(getFlow(flowId).trigger.uri, 'trigger', getFlow(flowId).trigger.id).tokens.forEach(token => {
        testflow.tokens[token.name] = token.example.en
      })
    }

    testflow.flow.conditions =  getFlow(flowId).conditions
    testflow.flow.actions = getFlow(flowId).actions
    test(flowId, testflow, null)
  }
</script>
</body>
</html>
