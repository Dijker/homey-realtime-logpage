<html>
<head>
  <title>Flow Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="config.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/js/bootstrap-dialog.min.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
  <script>
    jQuery.expr[':'].icontains = jQuery.expr.createPseudo(function (arg) {
      return function (elem) {
        return jQuery(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0
      }
    })
  </script>
  <style>
    .well {
      margin-bottom: 5px;
    }
    .col-sm-5, .col-sm-2 {
      padding-right: 5px;
      padding-left: 5px;
    }
  </style>
</head>
<body>
  <div class=container-fluid>
    <h1>Homey flow viewer</h1>
    <div class="form-group has-feedback">
        <input id="search" type="text" class="form-control" placeholder="Search" onKeyDown="search()" onKeyUp="search()" onChange="search()"/>
        <i class="glyphicon glyphicon-search form-control-feedback"></i>
    </div>
    <div id="flows">
      <span id="wait">Wait for it...</span>
    </div>
    <div class="hide">
      <div class="template_flow">
        <div class="panel panel-success" data="flow_panel">
          <div class="panel-heading">
            <div class="row">
              <div class="col-sm-4" data="flow_path"></div>
              <div class="col-sm-4 text-center">
                <span class="text-muted" data="test_btn" data-toggle="tooltip" title="Test flow"><i class="fa fa-play"></i></span>
                &nbsp;&nbsp;
                <strong data="title"></strong>
              </div>
              <div class="col-sm-4 text-right">
                <span class="label label-default" data="label_disabled"></span>
                <span class="label label-danger" data="label_broken"></span>
                <button class="btn btn-default" data="toggle_btn" data-toggle="tooltip" title="Enable or disable"><i class="fa fa-square-o"></i></button>
                <button class="btn btn-default" data="edit_btn"   data-toggle="tooltip" title="Rename & Move"><i class="fa fa-pencil"></i></button>
                <button class="btn btn-default" data="copy_btn"   data-toggle="tooltip" title="Copy"><i class="fa fa-clone"></i></button>
                <button class="btn btn-default" data="delete_btn" data-toggle="tooltip" title="Delete"><i class="fa fa-remove"></i></button>
              </div>
            </div>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-sm-2 small">
                <div class="text-muted">Trigger</div>
                <span data="cards_trigger"/>
              </div>
              <div class="col-sm-5 small">
                <div class="text-muted">Conditions</div>
                <span data="cards_condition"/>
              </div>
              <div class="col-sm-5 small">
                <div class="text-muted">Actions</div>
                <span data="cards_action"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="template_card">
        <div class="well well-sm">
          <span class="label label-danger" data="label_danger"></span>
          <!-- <button class="btn btn-default btn-small" data="test_btn" data-toggle="tooltip" title="Test card"><i class="fa fa-play"></i></button> -->
          <span class="label label-success pull-right" data="card_type_device"></span>
          <span class="label label-info pull-right" data="card_type_app"></span>
          <span class="label label-primary pull-right" data="card_type_manager"></span>
          <!-- <span class="text-muted" data="edit_card_btn" data-toggle="tooltip" title="Edit"><i class="fa fa-pencil"></i></span>&nbsp; -->
          <span class="text-muted" data="test_card_btn" data-toggle="tooltip" title="Test"><i class="fa fa-play"></i></span>
          &nbsp;&nbsp;
          <span class="text-nowrap"><strong data="card_title"></strong></span><br>
          <span class="text-muted" data="card_args"></span>
          <span class="text-muted" data="card_delay"></span>
          <span class="text-muted" data="card_droptoken"></span>
        </div>
      </div>

      <div class="dialog_copy form-group">
        <label for="copyName">New name</label>
        <input id="copyName" class="form-control" type="text"  value="">
        <label for="copyFolder">Copy to folder</label>
        <select id="copyFolder" class="form-control">
          <option value="false">None</option>
        </select>
      </div>

      <div class="dialog_edit form-group">
        <label for="editName">Name</label>
        <input id="editName" class="form-control" type="text"  value="">
        <label for="editFolder">Folder</label>
        <select id="editFolder" class="form-control">
          <option value="false">None</option>
        </select>
      </div>

    </div>
  </div>
  <script>
  var devices = []
  var cards
  var folders = []
  var flows = []

  if (setup.ip === '0.0.0.0') alert('Configure your Homey IP in this script...')
  if (setup.bearer_token === 'your token') alert('Configure your Bearer token in this script...')

  $.ajaxSetup({
    contentType : 'application/json',
    headers: {Authorization: 'Bearer ' + setup.bearer_token}
  })

  String.prototype.capitalizeFirstLetter = function() {
      return this.charAt(0).toUpperCase() + this.slice(1)
  }

  function addFlow (flow) {
    var newFlow = $('.template_flow').clone()
    $(newFlow).find('[data=flow_panel]').attr('flow_panel_id', flow.id)
    $(newFlow).find('[data=title]').html(`<a href="${setup.protocol}://${setup.ip}/manager/flow/#${flow.id}" target=_new>${flow.title}</a>`)
    $(newFlow).find('[data=cards_trigger]').append(formatCard(flow.id, flow.trigger, 'trigger', 0).html())
    $(newFlow).find('[data=cards_condition]').append(formatCards(flow, 'conditions').html())
    $(newFlow).find('[data=cards_action]').append(formatCards(flow, 'actions').html())
    $(newFlow).find('[data=toggle_btn]').attr('onClick', `toggleFlow('${flow.id}')`)
    $(newFlow).find('[data=edit_btn]').attr('onClick', `editFlow('${flow.id}')`)
    $(newFlow).find('[data=copy_btn]').attr('onClick', `copyFlow('${flow.id}')`)
    $(newFlow).find('[data=delete_btn]').attr('onClick', `deleteFlow('${flow.id}')`)
    $(newFlow).find('[data=test_btn]').attr('onClick', `testFlow('${flow.id}')`)
    if (flow.folder) $(newFlow).find('[data=flow_path]').html('<i class="fa fa-folder-open" aria-hidden="true"></i> ' + formatFolder(flow.folder))
    if (flow.broken) {
      $(newFlow).find('[data=flow_panel]').removeClass("panel-success").addClass("panel-danger")
      $(newFlow).find('[data=label_broken]').html("BROKEN")
    }
    $('#flows').append(newFlow.html())
    showFlowToggleButton(flow.id)
  }

  function noCard () {
    var noCard = $('<div />')
    noCard.html('<br><span class="label label-danger">NO CARD</span>')
    return noCard
  }

  function formatCards (flow, type) {
    if (type === 'actions' && flow[type].length === 0) return noCard()
    var newCards = $("<div />")
    flow[type].forEach(function (card, index) {
      newCards.append(formatCard(flow.id, card, type, index).html())
    })
    return newCards
  }

  function formatCard (flowId, card, type, index) {
    if (isEmptyObject(card)) return noCard()
    var newCard = $('.template_card').clone()
    var definitions = getCard(card.uri, (type === 'trigger') ? type : type.slice(0, -1), card.id)
    var app = getApp(card.uri)

    if (type === 'conditions') {
      $(newCard).find('[data=card_title]').html(conditionTitleParse(definitions.title.en, !card.inverted))
    } else {
      $(newCard).find('[data=card_title]').html(definitions.title.en)
    }

    $(newCard).find('[data=card_type_' + app.uriObj.type + ']').html(app.uriObj.name)
    if (!isEmptyObject(card.args)) $(newCard).find('[data=card_args]').html(formatArgs(card))
    if (card.delay && card.delay.number > 0) $(newCard).find('[data=card_delay]').html('<i>delay</i>: ' + (card.delay.number * card.delay.multiplier) + ' seconds')
    if (card.droptoken) $(newCard).find('[data=card_droptoken]').html('<i>token</i>: <code>' + (card.droptoken) + '</code>')
    if (definitions.tokens) {
      var tokens = '<i>tokens</i>: '
      definitions.tokens.forEach(token => {
        tokens += '<code>' + (token.name) + '</code> '
      })
      $(newCard).find('[data=card_droptoken]').html(tokens)
    }

    $(newCard).find('[data=test_card_btn]').attr('onClick', `testCard('${flowId}','${type}',${index})`)
    if (type !== 'actions') $(newCard).find('[data=test_card_btn]').remove()

    return newCard
  }

  function formatFolder (id) {
    var result = getFolder(id).title
    if (getFolder(id).folder) result = formatFolder(getFolder(id).folder) + " > " + result
    return result
  }

  function formatArgs (card) {
    var output = ''
    Object.keys(card.args).forEach(function (argument) {
      output += '<i>' + argument + '</i>: ' + JSON.stringify(card.args[argument]) + '<br>'
    })
    output = output.replace('[[', '<code>').replace(']]', '</code>')
    return output
  }

  function isEmptyObject (obj) {
    return Object.getOwnPropertyNames(obj).length === 0
  }

// ////////////////////////////////// HOMEY COPIED FUNCTIONS
  function conditionTitleParse (e, t) {
    var a = e.match(/\!\{\{([^]+)\}\}/g)
    return null === a ? e : (a.forEach(function(a) {
      var n = a
      if ("!" == a.charAt(0) && (a = a.substring(1)),
      a = a.replace("{{", ""),
      a = a.replace("}}", ""),
      a = a.split("|"),
      t ? a = a[0] : ("" != a[0] && (a[0] = "&nbsp;" + a[0]),
      "" != a[1] && (a[1] = "&nbsp;" + a[1]),
      a = a[0] + a[1]),
      e = e.replace(n, a),
      !t) {
        var o = e.indexOf(a)
        o > 0 && (e = spliceSlice(e, o - 1, 1))
      }
    }),
    e)
  }

  function spliceSlice(e, t, a, n) {
    return e.slice(0, t) + (n || '') + e.slice(t + a)
  }
// ////////////////////////////////// HOMEY COPIED FUNCTIONS

  function getApp (uri) {
    return cards.filter(app => app.uri === uri)[0]
  }

  function getCard (uri, type, id) {
    return getApp(uri).cards[type].filter(card => card.id === id)[0]
  }

  function getDevice (id) {
    return devices.filter(device => device.id === id)[0]
  }

  function getFlow (id) {
    return flows.filter(flow => flow.id === id)[0]
  }

  function getFolder (id) {
    return folders.filter(folder => folder.id === id)[0]
  }

  function loadCards (callback) {
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/card/`, function(data) {
      cards = data.result
      callback()
    })
  }

  function loadDevices (callback) {
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/devices/device/`, function(data) {
      $.each(data.result, function (index, resultDevice) {
        devices.push({id: resultDevice.id, name: resultDevice.name})
      })
      callback()
    })
  }

  function loadFlows (callback) {
    // get all flow folders
    flows = []
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/`, function(data) {
      $.each(data.result, function (index, flow) {
        flows.push(flow)
      })
      callback()
    })
  }

  function loadFolders (callback) {
    folders = []
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/folder/`, function(data) {
      $.each(data.result, function (index, folder) {
        folders.push(folder)
      })
      sortFolders()
      callback()
    })
  }

  function folderOrder (id) {
    var order = formatOrderNumber(getFolder(id).order) + '|'
    if (getFolder(id).folder) order = folderOrder(getFolder(id).folder) + order
    return order
  }

  function formatOrderNumber (order) {
    return ('00000' + order).slice(-5)
  }

  function sortFolders () {
    folders.forEach(folder => {
      folder.sorting = folderOrder(folder.id)
    })
    folders.sort((a, b) => (a.sorting > b.sorting ? 1 : -1))
  }

  function showFlows () {
    flows.forEach(flow => {
      flow.order = formatOrderNumber(flow.order)
      if (flow.folder) flow.order = folderOrder(flow.folder) + flow.order
    })
    flows.sort((a, b) => (a.order > b.order ? 1 : -1))
    flows.forEach(flow => {
      addFlow(flow)
    })
    $('#wait').remove()
    $('[data-toggle="tooltip"]').tooltip()
  }

  loadDevices(() => {
    loadFolders(() => {
      loadCards(() => {
        loadFlows(() => {
          showFlows()
        })
      })
    })
  })

  function copyFlow (flowId) {
    copyFlowDialog(flowId, function(newName, newFolder) {
      if (newName) {
        if (newFolder === 'false') newFolder = false
        $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
          if (data.status !== 200) return alert('Copy failure... getting existing flow')
          var existingFlow = data.result
          $.post(`${setup.protocol}://${setup.ip}/api/manager/flow/flow`, function(data) {
            if (data.status !== 200) return alert('Copy failure... requesting new id')
            var newFlow = existingFlow
            newFlow.id = data.result.id
            newFlow.title = newName
            newFlow.folder = newFolder
            newFlow.order = data.result.order
            $.ajax({
              url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${newFlow.id}`,
              type: 'PUT',
              data: JSON.stringify(newFlow),
              success: function(data) {
                location.reload()
              }
            })
          })
        })
      }
    })
  }

  function deleteFlow (flowId) {
    deleteFlowDialog(flowId, function(doDelete) {
      if (!doDelete) return
      $.ajax({
        url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
        type: 'DELETE',
        success: function(data) {
          $(`[flow_panel_id=${flowId}]`).slideUp(1000)
        }
      })
    })
  }

  function showFlowToggleButton (flowId) {
    if (getFlow(flowId).enabled) {
      $(`[flow_panel_id=${flowId}] [data=label_disabled]`).html("")
      $(`[flow_panel_id=${flowId}] [data=toggle_btn] i`).removeClass('fa-square-o').addClass('fa-check-square-o')
      if (!getFlow(flowId).broken) {
        $(`[flow_panel_id=${flowId}]`).removeClass("panel-default").addClass("panel-success")
      }
    } else {
      $(`[flow_panel_id=${flowId}] [data=label_disabled]`).html("DISABLED")
      $(`[flow_panel_id=${flowId}] [data=toggle_btn] i`).removeClass('fa-check-square-o').addClass('fa-square-o')
      if (!getFlow(flowId).broken) {
        $(`[flow_panel_id=${flowId}]`).removeClass("panel-success").addClass("panel-default")
      }
    }
  }

  function editFlow (flowId) {
    editFlowDialog(flowId, function(newName, newFolder) {
      if (newName) {
        if (newFolder === 'false') newFolder = false
        $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
          if (data.status !== 200) return alert('Edit failure... getting existing flow')
          var existingFlow = data.result
          existingFlow.title = newName
          existingFlow.folder = newFolder
          $.ajax({
            url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
            type: 'PUT',
            data: JSON.stringify(existingFlow),
            success: function(data) {
              location.reload()
            }
          })
        })
      }
    })
  }

  function toggleFlow (flowId) {
    flows.filter(flow => flow.id === flowId)[0].enabled = !getFlow(flowId).enabled
    $.ajax({
      url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
      type: 'PUT',
      data: JSON.stringify({enabled: getFlow(flowId).enabled}),
      success: function(data) {
        showFlowToggleButton(flowId)
      }
    })
  }

  function copyFlowDialog (flowId, callback) {
    var message = $('.dialog_copy').clone()
    $(message).find('[id=copyName]').attr('value', `${getFlow(flowId).title} (copy)`)
    folders.forEach(folder => {
      $(message).find('[id=copyFolder]').append($("<option></option>").attr("value", folder.id).text(formatFolder(folder.id)))
    })
    $(message).find('[id=copyFolder]').val(getFlow(flowId).folder.toString())
    BootstrapDialog.show({
      title: 'Copy flow',
      message: message,
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Copy',
          action: function (dialogRef) {
            var newName = dialogRef.getModalBody().find('[id=copyName]').val()
            var newFolder = dialogRef.getModalBody().find('[id=copyFolder]').val()
            dialogRef.close()
            callback(newName, newFolder)
          }
        }
      ]
    })
  }

  function deleteFlowDialog (flowId, callback) {
    BootstrapDialog.show({
      title: 'Delete flow',
      message: 'Are you sure you want to delete flow ' + getFlow(flowId).title + '?',
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Delete',
          action: function (dialogRef) {
            dialogRef.close()
            callback(true)
          }
        }
      ]
    })
  }

  function editFlowDialog (flowId, callback) {
    var message = $('.dialog_edit').clone()
    $(message).find('[id=editName]').attr('value', `${getFlow(flowId).title}`)
    folders.forEach(folder => {
      $(message).find('[id=editFolder]').append($("<option></option>").attr("value", folder.id).text(formatFolder(folder.id)))
    })
    $(message).find('[id=editFolder]').val(getFlow(flowId).folder.toString())
    BootstrapDialog.show({
      title: 'Edit and move flow',
      message: message,
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Save',
          action: function (dialogRef) {
            var editName = dialogRef.getModalBody().find('[id=editName]').val()
            var editFolder = dialogRef.getModalBody().find('[id=editFolder]').val()
            dialogRef.close()
            callback(editName, editFolder)
          }
        }
      ]
    })
  }

  function search () {
    value = $('[id=search]').val()
    $('[data=flow_panel]').hide()
    $(`:contains(${value})`).parents('[data=flow_panel]').show()
  }

  function testCard (flowId, type, index) {
    var testflow = {
      "flow":{
        "trigger":{},
        "conditions":[],
        "actions":[]
      },
      "tokens":{}
    }

    if (!isEmptyObject(getFlow(flowId).trigger)) {

      (getCard(getFlow(flowId).trigger.uri, 'trigger', getFlow(flowId).trigger.id).tokens || []).forEach(token => {
        testflow.tokens[token.name] = token.example.en
      })
    }

    testflow.flow.actions.push(getFlow(flowId)[type][index])
    $.ajax({
      url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/test/`,
      type: 'POST',
      data: JSON.stringify(testflow),
      success: function(data) {
        console.log(data)
      }
    })
  }

  function testFlow (flowId) {
    var testflow = {
      "flow":{
        "trigger":{},
        "conditions":[],
        "actions":[]
      },
      "tokens":{}
    }

    if (!isEmptyObject(getFlow(flowId).trigger)) {
      getCard(getFlow(flowId).trigger.uri, 'trigger', getFlow(flowId).trigger.id).tokens.forEach(token => {
        testflow.tokens[token.name] = token.example.en
      })
    }

    testflow.flow.conditions =  getFlow(flowId).conditions
    testflow.flow.actions = getFlow(flowId).actions
    $.ajax({
      url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/test/`,
      type: 'POST',
      data: JSON.stringify(testflow),
      success: function(data) {
        console.log(data)
      }
    })
  }
</script>
</body>
</html>
